<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width"/>
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/cheng.css" />

	<style>
  body{
    background: url(../../image/bg2.png);
    width: 100%;
    height: 568px;
  }
  /*#id0{
    background: red;
  }*/
	</style>
</head>
<body>
  <!-- 切换成员 -->
  <div class="bodywrap">


  <div class="users">
      <img class='qiehuan' src="../../image/qiehuan.png" alt="">
      <span class='qiehuan-title'>切换成员</span>
      <div class="bigwrap"></div>
      <a href="newuser.html" class="adduser">
        <img src="../../image/add.png" alt="">
        <span>添加新成员</span>
      </a>
  </div>
  <div class="head"  style='background:#2F3747;'>
    <a  class="user">
      <img src="../../image/user.png" alt="">
    </a>
    <p class='head-title'>KIMMON</p>
    <a  class="cheng">
      <img src="../../image/cheng.png" alt="">
    </a>
  </div>

  <div class="content">
    <div class="lian">
      <div class="zuobar"></div>
      <span class='bartitle'>请连接设备</span>
      <div class="youbar"></div>
    </div>
    <p class='tizhong'><span class='tizhong2'>0.0</span></p>
    <p class='defen'>0.0</p>
    <div class="point">
      <span class='span1'></span>
      <span></span>
      <span></span>
    </div>
    <img class='biaopan' src="../../image/biaopan.png" alt="">

    <div class="quzhi quzhi1">
      <img src="../../image/quzhi.png" alt="">
      <p>去脂体重</p>
      <p><span class="quzhitizhong2"></span>kg</p>
    </div>
    <div class="quzhi bmi">
      <img src="../../image/bmi.png" alt="">
      <p>BMI</p>
      <p class="bmi2">18.21</p>
    </div>
    <div class="quzhi tishui">
      <img src="../../image/tishui.png" alt="">
      <p>体水分</p>
      <p><span class='tishuifen2'></span>%</p>
    </div>
    <div class="quzhi zhifang">
      <img src="../../image/zhifang.png" alt="">
      <p>脂肪率</p>
      <p><span class='zhifanglv2'></span>%</p>
    </div>
  </div>
  <div class="bottom">
    <div class="change">
        <img src="../../image/jiance.png" alt="">
        <p>检测</p>
    </div>
    <div class="change">
        <img class='sc' src="../../image/shangcheng.png" alt="">
        <p>商城</p>
    </div>
    <div class="change">
        <img src="../../image/xitong.png" alt="">
        <p>系统</p>
    </div>
    <div class="change">
        <img src="../../image/hudong.png" alt="">
        <p>互动</p>
    </div>
    <div class="change">
        <img class='wo' src="../../image/wo.png" alt="">
        <p>我</p>
    </div>
  </div>


  </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/flexible_css.js"></script>
<script type="text/javascript" src="../../script/flexible.js"></script>
<script type="text/javascript" src="../../script/c.js"></script>


<script type="text/javascript">
var nowuser = {
  "nicename":"请先添加用户","sex":-1,"birthday":[],"cm":""
}
var chengiosdata;
var open = 0;
// 打开
ccc('.user').onclick = function(){
  console.log('open')
  setTimeout(function(){
    open=1;
  })
  ccc('.users').style.left = '0px';
}
// 移动检测
// ccc('.bodywrap').addEventListener("touchstart", function(e) {
//     console.log(e.touches[0].pageX, e.touches[0].pageY);
// });
// ccc('.bodywrap').addEventListener("touchmove", function(e) {
//     if(e.touches.length > 1 || e.scale && e.scale !== 1) return;
//     console.log(e.touches[0].pageX, e.touches[0].pageY);
// });
// ccc('.bodywrap').addEventListener("touchend", function(e) {});

ccc('.tizhong2').onclick = function(){
  window.location.href='chengRep.html';
}

// 关闭
ccc('.bodywrap').onclick = function(event){
  // console.log(event)
    event = event || window.event;
    var target = event.target || event.srcElement;
    if(open>0){
      if(target != ccc('.users')&&target != ccc('.qiehuan')&&target != ccc('.qiehuan-title')){
        console.log('close')
        open=0;
          ccc('.users').style.left = '-6.4rem';
      }
    }

}

// 读取本地缓存用户并且渲染
function userData(){
  if(!$api.getStorage('user')) return;
    var userdata = $api.getStorage('user');
var userhtml='';
    for(var key in userdata){
      console.log(key)
      userhtml +=`<div class="userwrap" id=${'id'+key}>
          <div class="touxiang">${userdata[key].nickname[0]}</div>
          <p>${userdata[key].nickname}</p>
      </div>`
    }
    ccc('.bigwrap').innerHTML = userhtml;
}
console.log($api.getStorage('user'))

// 检测
// 数据


// 需要6个数据，1体重，2得分，3去脂体重，4BMI,5体水分，6脂肪率
var user_H,user_sex,user_age;
      apiready =

      function start(){
        var systemType = api.systemType;
        console.log(systemType)

        $api.setStorage('page',1);

        // 计算body高度
        console.log(JSON.stringify($api.getStorage('user')))
        setTimeout(function(){ccc('.users').style.opacity = 1;},500)
        document.querySelector('body').style.height = api.winHeight+'px';
        userData();


        var d = new Date();
        // 身高
         user_H = nowuser.cm;
        // 性别，0为女，1为男，-1为未定义用户
         user_sex = nowuser.sex;
        // 用户年龄
         user_age = (d.getFullYear() - +nowuser.birthday[0]);


        // if(systemType=='ios'){
        //   ioschengStart(user_H,user_sex,user_age);
        //
        // }else{
        //   bodyseach(user_H,user_sex,user_age);
        //
        // }

    };

    // 默认登录选择第一个
    if($api.getStorage('user')){
      $api.setStorage('nowuser',Json2Str($api.getStorage('user')[0]))
        nowuser = $api.getStorage('user')[0];
        ccc('.head-title').innerHTML = nowuser.nickname;
    }else {
        ccc('.head-title').innerHTML = nowuser.nickname;
    }



    // // 移动检测
    // var startX,moveX,endX;
    // ccc('.bodywrap').addEventListener("touchstart", function(e) {
    //     console.log(e.touches[0].pageX, e.touches[0].pageY);
    //     startX = e.touches[0].pageX;
    //     endX=0;
    // });
    // ccc('.bodywrap').addEventListener("touchmove", function(e) {
    //     if(e.touches.length > 1 || e.scale && e.scale !== 1) return;
    //     moveX = e.touches[0].pageX;
    //     endX=1;
    // });
    // ccc('.bodywrap').addEventListener("touchend", function(e) {
    //   console.log('开始：'+startX);
    //   console.log('结束：'+moveX);
    //   if(!endX){
    //     moveX=startX;
    //   }
    //   if(moveX-startX>20){
    //     console.log('向右滑动')
    //     if($api.getStorage('page')==2){
    //       window.location.href='cheng.html';
    //     }
    //   }else if(moveX-startX<-20){
    //     if($api.getStorage('page')==1){
    //       window.location.href='shouhuan.html';
    //     }
    //     console.log('向左滑动')
    //   }
    // });






    function bodyseach(user_H,user_sex,user_age){
      // 检测如果没有用户信息即返回
      if(user_sex<0){
        return;
      }
      console.log('通过检测，性别:'+user_sex)
      console.log('通过检测，身高:'+user_H)
      console.log('通过检测，age:'+user_age)

      var ble= api.require('ble');
      var uz = api.require('moduleDemo');

      var uuid = '';
      var uup = '';
      ble.initManager(function(ret) {
      if (ret.state == "poweredOn") {
          setInterval(function() {
            ble.scan(function(ret) {
                if (ret.status) {
                  ble.getPeripheral(function(ret) {
                      if (ret) {
                         var p= ret.peripherals;
                         if(p){
                           for(var i=0;i<p.length;i++){
                             if(p[i].name=='ADV'){
                               uuid=p[i].uuid;
                              var manufacturerData = p[i].manufacturerData;
                               uup = p[i];
                               if(!$api.getStorage('jihuostate')){
                                  var param = {};
                                  param.appParam = uuid;
                                  function resultCallback(ret, err) {
                                    console.log(ret.macresult)
                                       if(ret.macresult=='已经在激活状态！'){
                                         $api.setStorage('jihuostate', '2');
                                       }else if(ret.macresult=='激活成功！'){
                                         $api.setStorage('jihuostate', '1');
                                       }
                                   }
                                   uz.mactest(param, resultCallback);
                               }
                               var a = manufacturerData.slice(manufacturerData.indexOf("ca")).slice(0,30);
                               console.log(a)
                               var newarr =[];
  		                         for(var i=0;i<a.split('').length;i=i+2){
  			                          newarr.push(a[i]+''+a[i+1])
  		                         }
                               var jinkg = parseInt(newarr[8],16).toString(2);
                               user_W  =f2to10(f16to2(newarr[10]),f16to2(newarr[11]),jinkg);
                               user_R = f2to10(f16to2(newarr[12]),f16to2(newarr[13]))/100;
                               console.log(jinkg);
                               console.log(user_W);
                               console.log(user_R);
                               if(user_R){
                                 bodyData(user_H,user_sex,user_age,user_W,user_R);
                               }
                              //  setTimeout(bodyData,2000)
                               if(manufacturerData){
                                 ble.stopScan();
                                 manufacturerData='';
                               }
                               function bodyData(user_H,user_sex,user_age,user_W,user_R){
                                 var uz = api.require('moduleDemo');
                                 var param1 = {
                                     height: user_H.toString(),
                                     sex: user_sex.toString(),
                                     age: user_age.toString(),
                                     weight: user_W.toString(),
                                     r: user_R.toString()
                                 };
                                 var resultCallback1 = function(ret, err) {
                                    //  document.getElementById("activity_result").innerHTML = JSON.stringify(ret);
                                    // console.log(JSON.stringify(ret))
                                    // alert(JSON.stringify(ret))
                                             if(chengiosdata!=ret&&ret){
                                               chengiosdata = ret;
                                               ccc('.tizhong2').innerHTML = user_W;
                                               ccc('.defen').innerHTML = parseFloat(ret['评分']).toFixed(1);
                                               ccc('.quzhitizhong2').innerHTML = parseFloat(ret['去脂体重LBM']).toFixed(1);
                                               ccc('.bmi2').innerHTML = (user_W/(user_H*user_H/10000)).toFixed(1);
                                               ccc('.tishuifen2').innerHTML = parseFloat(ret['含水百分比TFR']).toFixed(1);
                                               ccc('.zhifanglv2').innerHTML = parseFloat(ret['脂肪百份比BFR']).toFixed(1);
                                             }
                                 }
                                 console.log(user_H.toString());
                                 console.log(user_sex.toString());
                                 console.log(user_age.toString());
                                 console.log(user_W.toString());
                                 console.log(user_R.toString());
                                 console.log('================')

                                 uz.datainfo(param1, resultCallback1);
                               }

                             }
                           }
                         }

                      }
                    });
                  }
              });
              console.log('---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------'+new Date+'----'+uuid+'---------')
          },2000)
      }else{
          // 提示蓝牙还没打开
          console.log('蓝牙没打开')
      }
  });
    }


    function ioschengStart(user_H,user_sex,user_age) {
      var ble = api.require('ble');
      var uuid = '';
      ble.initManager(function(ret) {
      if (ret.state == "poweredOn") {
        // document.querySelector('.state').innerHTML = '蓝牙已连接'
          setInterval(function() {
            console.log(JSON.stringify(chengiosdata));
            ble.scan(function(ret) {
                if (ret.status) {
                  ble.getPeripheral(function(ret) {
                      if (ret) {
                         var p= ret.peripherals;
                         if(p){
                           for(var i=0;i<p.length;i++){
                             if(p[i].name=='ADV'){
                               uuid=p[i].uuid;
                               manufacturerData = p[i].manufacturerData;

                               var a = manufacturerData;
                               var newarr =[];
  		                         for(var i=0;i<a.split('').length;i=i+2){
  			                          newarr.push(a[i]+''+a[i+1])
  		                         }
                               var jinkg = parseInt(newarr[8],16).toString(2);
                               user_W  =f2to10(f16to2(newarr[10]),f16to2(newarr[11]),jinkg);
                               user_R = f2to10(f16to2(newarr[12]),f16to2(newarr[13]))/100;
                                     test2(user_H,user_W,user_sex,user_age,user_R)
                               if(manufacturerData){
                                 ble.stopScan();
                                 manufacturerData='';
                               }
                             }
                           }
                         }

                      }
                    });
                  }
              });
          },2000)
      }else{
        // 蓝牙未连接
      }
  });
  function test2(h,w,sex,age,r){
    if(!w&&!r){
      return;
    }
      var demo = api.require('moduleDemo');
      demo.sdkinfo_ios({height: h,weight:w,sex:sex,age:age,r:r,year:'2018'},function(ret, err){
          //  var msg = "回调信息是2" + JSON.stringify(ret);
          //  console.log(msg)
           if(chengiosdata!=ret&&ret){
             chengiosdata = ret;
             ccc('.tizhong2').innerHTML = w;
             ccc('.defen').innerHTML = parseFloat(ret.getTotalScore).toFixed(1);
             ccc('.quzhitizhong2').innerHTML = parseFloat(ret.getLBM).toFixed(1);
             ccc('.bmi2').innerHTML = (w/(h*h/10000)).toFixed(1);
             ccc('.tishuifen2').innerHTML = parseFloat(ret.getTFR).toFixed(1);
             ccc('.zhifanglv2').innerHTML = parseFloat(ret.getBFR).toFixed(1);
           }
      });
      }
    }
</script>
</html>
